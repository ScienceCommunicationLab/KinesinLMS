!function(){"use strict";!function(){function e(e=!1){console.log("Disabling read-only block controls: ",e);const n=document.getElementById("btn-edit-course-unit-info");n&&n.classList.toggle("disabled",e);const o=document.getElementById("btn-toggle-wysiwyg");o&&o.classList.toggle("disabled",e);const t=document.getElementById("btn-add-block-end");t&&(console.log("Disabling add block at end button: ",t),t.classList.toggle("disabled",e)),document.querySelectorAll(".connector-add-block-button").forEach((n=>{console.log("Disabling add block button: ",n),n.classList.toggle("disabled",e)})),document.querySelectorAll(".block-edit-card-read-only").forEach((n=>{[".btn-block-edit",".btn-block-delete",".btn-block-move-up",".btn-block-move-down",".connector-add-block-button"].forEach((o=>{const t=n.querySelector(o);t&&(console.log("Disabling control: ",t),t.classList.toggle("disabled",e))}))}))}function n(e){console.log("klmsHTMLContentOnDragEnter"),e.preventDefault(),e.stopPropagation();const n=document.getElementById("image_drop_zone");n&&n.classList.add("drag-drop-highlight")}function o(e){console.log("klmsHTMLContentOnDragOver"),e.preventDefault(),e.stopPropagation();const n=document.getElementById("image_drop_zone");n&&n.classList.add("drag-drop-highlight")}function t(e){console.log("klmsHTMLContentOnDragLeave"),e.preventDefault(),e.stopPropagation();const n=document.getElementById("image_drop_zone");n&&n.classList.remove("drag-drop-highlight")}function i(e){console.log("klmsHTMLContentOnDrop"),e.preventDefault(),e.stopPropagation();const n=document.getElementById("image_drop_zone");if(!n)return;n.classList.remove("drag-drop-highlight"),console.log("dropZoneElem: ",n),console.log("dropZoneElem.dataset: ",n.dataset);const o=n.dataset.courseId,t=n.dataset.blockId;console.log("drop event. blockID: ",t),console.log("drop event. blockIcourseIDD: ",o);const i=e.dataTransfer;if(i&&o&&t){const e=i.files;console.log("files: ",e),Array.from(e).forEach((e=>{console.log("uploading file: ",e),function(e,n,o){console.log("klmsUploadCourseResourceFile: ",e,n,o);const t=new FormData;t.append("resource_file",e),t.append("type","IMAGE");const i=new XMLHttpRequest,l=document.body.getAttribute("hx-headers");let s="";if(l)try{s=JSON.parse(l)["X-CSRFToken"]||""}catch(e){console.error("Failed to parse CSRF token:",e)}console.log("csrfToken: ",l);const r=`/composer/course/${n}/block/${o}/upload_course_resource/`;i.open("POST",r,!0),i.setRequestHeader("X-CSRFToken",s);const c='Error occurred during upload. Please try again, or manually add the resource on the "Resources" tab.';i.onload=function(){if(201===i.status){const e=JSON.parse(i.responseText);console.log("Upload successful: ",i.responseText),function(e){console.log("klmsUpdateTextWithNewImageURL: ",e);const n=`<img src="${e}" alt="image" />`,o=document.getElementById("id_html_content");if(tinyMCE&&tinyMCE.activeEditor){console.log("TinyMCE is active. Updating with img tag...");const e=tinyMCE.activeEditor;e.selection.getRng(),e.selection.setContent(n),console.log("Dispatching 'change' event from ",e)}else{if(console.log("Raw HTML textarea is active. Updating with img tag..."),!o)return;const e=o.selectionStart,t=`${o.value.substring(0,e)}\n${n}\n${o.value.substring(e)}`;o.value=t}console.log("Dispatching 'change' event from ",o),o.dispatchEvent(new Event("change",{bubbles:!0}))}(e.resource_url)}else window.alert(c),console.error("Upload failed:",i.status)},i.onerror=function(){window.alert(c)},i.send(t)}(e,o,t)}))}}function l(){const e=document.getElementById("image_drop_zone");e&&(e.removeEventListener("dragenter",n,!1),e.removeEventListener("dragover",o,!1),e.removeEventListener("dragleave",t,!1),e.removeEventListener("drop",i,!1),e.addEventListener("dragenter",n,!1),e.addEventListener("dragover",o,!1),e.addEventListener("dragleave",t,!1),e.addEventListener("drop",i,!1))}document.body.addEventListener("htmx:configRequest",(e=>{if(!e)return void console.error("htmx:configRequest event is null",e);const n=e.detail.target.id;if(n.includes("block-edit-form-")||n.includes("course-unit-block-")){if(!tinyMCE||!tinyMCE.activeEditor)return void console.log("We're editing raw HTML so no need to copy content from TinyMCE...");console.log("Copying content from TinyMCE before making HTMx request..."),["html_content","question_text"].forEach((n=>{const o=e;if(o.detail&&n in o.detail.parameters){const e=`id_${n}`,t=tinyMCE.get(e);if(!t)return void console.error(`Could not find element with ID ${e}`);o.detail.parameters[n]=t.getContent()}}))}})),document.addEventListener("alpine:init",(()=>{Alpine.store("isEditingBlock",!1),Alpine.store("isEditingCourseUnitInfo",!1),console.log("Alpine init")})),document.body.addEventListener("editCourseUnitInfoActivated",(function(n){console.log("editCourseUnitInfoActivated",n),Alpine.store("isEditingCourseUnitInfo",!0),e(!0)})),document.body.addEventListener("editCourseUnitInfoDeactivated",(function(n){console.log("editCourseUnitInfoDeactivated",n),Alpine.store("isEditingCourseUnitInfo",!1),e(!1)})),document.body.addEventListener("editBlockPanelActivated",(function(n){Alpine.store("isEditingBlock",!0),console.log("editBlockPanelActivated",n);const o=n.detail;!function(e,n){const o=`panel-form-${e}-${n}`,t=document.getElementById(o);if(!t)return void console.error("Could not find DOM element",o);t.removeEventListener("change",u),t.removeEventListener("wysiwyg_change",u);const i=`btn-save-panel-${e}-${n}`,s=document.getElementById(i);s?s.disabled=!0:console.info("Could not find DOM element",i);const r=`btn-done-panel-${e}-${n}`,c=document.getElementById(r);c&&console.info("Could not find DOM element",r);const d=`btn-cancel-panel-${e}-${n}`,a=document.getElementById(d);a||console.info("Could not find DOM element",d);const g=new URLSearchParams(new FormData(t));function u(n){console.log("Panel form changed! event: ",n);let o=!0;if(tinyMCE&&tinyMCE.activeEditor);else{const e=new URLSearchParams(new FormData(t));o=e.toString()!==g.toString()}s&&(s.disabled=!o),c&&(c.disabled=o),a&&a.classList.toggle("d-none",!o),document.querySelectorAll(`#panel-navs-${e} button.nav-link`).forEach((e=>{e.disabled=o}))}t.addEventListener("change",u,!1),t.addEventListener("wysiwyg_change",u,!1),l()}(o.block_id,o.current_panel_slug),e(!0)})),document.body.addEventListener("editBlockPanelDeactivated",(function(n){Alpine.store("isEditingBlock",!1),e(!1)})),window.klmsInitComposerImageDropZone=l,window.klmsHTMLContentOnDragEnter=n,window.klmsHTMLContentOnDragOver=o,window.klmsHTMLContentOnDragLeave=t,window.klmsHTMLContentOnDrop=i,window.klmsDestroyCurrentPanelForm=function(){console.log("klmsDestroyCurrentPanelForm()"),tinyMCE&&(console.log("Destroying TinyMCE..."),tinyMCE.remove())}}()}();
//# sourceMappingURL=kinesinlms-composer.bundle.js.map