!function(){"use strict";!function(){function e(e=!1){console.log("Disabling read-only block controls: ",e);const o=document.getElementById("btn-edit-course-unit-info");o&&o.classList.toggle("disabled",e);const n=document.getElementById("btn-toggle-wysiwyg");n&&n.classList.toggle("disabled",e);const t=document.getElementById("btn-add-block-end");t&&(console.log("Disabling add block at end button: ",t),t.classList.toggle("disabled",e)),document.querySelectorAll(".connector-add-block-button").forEach((o=>{console.log("Disabling add block button: ",o),o.classList.toggle("disabled",e)})),document.querySelectorAll(".block-edit-card-read-only").forEach((o=>{[".btn-block-edit",".btn-block-delete",".btn-block-move-up",".btn-block-move-down",".connector-add-block-button"].forEach((n=>{const t=o.querySelector(n);t&&(console.log("Disabling control: ",t),t.classList.toggle("disabled",e))}))}))}function o(e){console.log("klmsHTMLContentOnDragEnter"),e.preventDefault(),e.stopPropagation();const o=document.getElementById("image_drop_zone");o&&o.classList.add("drag-drop-highlight")}function n(e){console.log("klmsHTMLContentOnDragOver"),e.preventDefault(),e.stopPropagation();const o=document.getElementById("image_drop_zone");o&&o.classList.add("drag-drop-highlight")}function t(e){console.log("klmsHTMLContentOnDragLeave"),e.preventDefault(),e.stopPropagation();const o=document.getElementById("image_drop_zone");o&&o.classList.remove("drag-drop-highlight")}function i(e){console.log("klmsHTMLContentOnDrop"),e.preventDefault(),e.stopPropagation();const o=document.getElementById("image_drop_zone");if(!o)return;o.classList.remove("drag-drop-highlight"),console.log("dropZoneElem: ",o),console.log("dropZoneElem.dataset: ",o.dataset);const n=o.dataset.courseId,t=o.dataset.blockId;console.log("drop event. blockID: ",t),console.log("drop event. blockIcourseIDD: ",n);const i=e.dataTransfer;if(i&&n&&t){const e=i.files;console.log("files: ",e),Array.from(e).forEach((e=>{console.log("uploading file: ",e),function(e,o,n){console.log("klmsUploadCourseResourceFile: ",e,o,n);const t=new FormData;t.append("resource_file",e),t.append("type","IMAGE");const i=new XMLHttpRequest,l=document.body.getAttribute("hx-headers");let s="";if(l)try{s=JSON.parse(l)["X-CSRFToken"]||""}catch(e){console.error("Failed to parse CSRF token:",e)}console.log("csrfToken: ",l);const r=`/composer/course/${o}/block/${n}/upload_course_resource/`;i.open("POST",r,!0),i.setRequestHeader("X-CSRFToken",s);const c='Error occurred during upload. Please try again, or manually add the resource on the "Resources" tab.';i.onload=function(){if(201===i.status){const e=JSON.parse(i.responseText);console.log("Upload successful: ",i.responseText),function(e){console.log("klmsUpdateTextWithNewImageURL: ",e);const o=`<img src="${e}" alt="image" />`,n=document.getElementById("id_html_content");if(tinyMCE&&tinyMCE.activeEditor){console.log("TinyMCE is active. Updating with img tag...");const e=tinyMCE.activeEditor;e.selection.getRng(),e.selection.setContent(o),console.log("Dispatching 'change' event from ",e)}else{if(console.log("Raw HTML textarea is active. Updating with img tag..."),!n)return;const e=n.selectionStart,t=n.value.substring(0,e),i=n.value.substring(e);n.value=`${t}\n${o}\n${i}`}console.log("Dispatching 'change' event from ",n),n.dispatchEvent(new Event("change",{bubbles:!0}))}(e.resource_url)}else window.alert(c),console.error("Upload failed:",i.status)},i.onerror=function(){window.alert(c)},i.send(t)}(e,n,t)}))}}function l(){const e=document.getElementById("image_drop_zone");e&&(e.removeEventListener("dragenter",o,!1),e.removeEventListener("dragover",n,!1),e.removeEventListener("dragleave",t,!1),e.removeEventListener("drop",i,!1),e.addEventListener("dragenter",o,!1),e.addEventListener("dragover",n,!1),e.addEventListener("dragleave",t,!1),e.addEventListener("drop",i,!1))}document.body.addEventListener("htmx:configRequest",(e=>{if(!e)return void console.error("htmx:configRequest event is null",e);const o=e.detail.target.id;if(o.includes("block-edit-form-")||o.includes("course-unit-block-")){if(!tinyMCE||!tinyMCE.activeEditor)return void console.log("We're editing raw HTML so no need to copy content from TinyMCE...");console.log("Copying content from TinyMCE before making HTMx request..."),["html_content","question_text"].forEach((o=>{const n=e;if(n.detail&&o in n.detail.parameters){const e=`id_${o}`,t=tinyMCE.get(e);if(!t)return void console.error(`Could not find element with ID ${e}`);n.detail.parameters[o]=t.getContent()}}))}})),document.addEventListener("alpine:init",(()=>{Alpine.store("isEditingBlock",!1),Alpine.store("isEditingCourseUnitInfo",!1),console.log("Alpine init")})),document.body.addEventListener("editCourseUnitInfoActivated",(function(o){console.log("editCourseUnitInfoActivated",o),Alpine.store("isEditingCourseUnitInfo",!0),e(!0)})),document.body.addEventListener("editCourseUnitInfoDeactivated",(function(o){console.log("editCourseUnitInfoDeactivated",o),Alpine.store("isEditingCourseUnitInfo",!1),e(!1)})),document.body.addEventListener("editBlockPanelActivated",(function(o){Alpine.store("isEditingBlock",!0),console.log("editBlockPanelActivated",o);const n=o.detail;!function(e,o){const n=`panel-form-${e}-${o}`,t=document.getElementById(n);if(!t)return void console.error("Could not find DOM element",n);t.removeEventListener("change",u),t.removeEventListener("wysiwyg_change",u);const i=`btn-save-panel-${e}-${o}`,s=document.getElementById(i);s?s.disabled=!0:console.info("Could not find DOM element",i);const r=`btn-done-panel-${e}-${o}`,c=document.getElementById(r);c&&console.info("Could not find DOM element",r);const d=`btn-cancel-panel-${e}-${o}`,a=document.getElementById(d);a||console.info("Could not find DOM element",d);const g=new URLSearchParams(new FormData(t));function u(o){console.log("Panel form changed! event: ",o);let n=!0;if(tinyMCE&&tinyMCE.activeEditor);else{const e=new URLSearchParams(new FormData(t));n=e.toString()!==g.toString()}s&&(s.disabled=!n,s.classList.toggle("d-none",!n),n&&s.focus()),c&&(c.disabled=n,c.classList.toggle("d-none",n)),a&&a.classList.toggle("d-none",!n),document.querySelectorAll(`#panel-navs-${e} button.nav-link`).forEach((e=>{e.disabled=n}))}t.addEventListener("change",u,!1),t.addEventListener("wysiwyg_change",u,!1),l()}(n.block_id,n.current_panel_slug),e(!0)})),document.body.addEventListener("editBlockPanelDeactivated",(function(o){Alpine.store("isEditingBlock",!1),e(!1)})),window.klmsInitComposerImageDropZone=l,window.klmsHTMLContentOnDragEnter=o,window.klmsHTMLContentOnDragOver=n,window.klmsHTMLContentOnDragLeave=t,window.klmsHTMLContentOnDrop=i,window.klmsDestroyCurrentPanelForm=function(){console.log("klmsDestroyCurrentPanelForm()"),tinyMCE&&(console.log("Destroying TinyMCE..."),tinyMCE.remove())}}()}();
//# sourceMappingURL=kinesinlms-composer.bundle.js.map