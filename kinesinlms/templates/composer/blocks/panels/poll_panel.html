{% comment %}
This is the default "panel" template to be used when showing a panel in a block editing UI.
It displays the form for the panel and the save/done buttons.

It also toggles the disabled state of the save/done buttons based on whether the form has changed.

If a panel needs a more complicated UI than this, it can override or replace this template.
(The template that a panel uses is defined in the Panel dataclass.)

{% endcomment %}

<div class="card">

    <div class="card-body panel-content">

        {% load crispy_forms_tags crispy_forms_filters %}

        {% csrf_token %}

        {{ panel_form.media }}
        {{ panel_form.choices.management_form }}
        {{ panel_form|as_crispy_errors }}

        {{ panel_form.label|as_crispy_field }}
        {{ panel_form.question|as_crispy_field }}

        {# Section for editing questions. #}
        <fieldset style="margin-bottom: 1rem;">
            <legend>Answer Choices</legend>
            <div class="fieldset-contents">

                <div class="row ">
                    <div class="col-1">
                        Key
                    </div>
                    <div class="col-9">
                        Answer
                    </div>
                    <div class="col-1">
                    </div>
                </div>

                <div id="choices-container-{{ block.id }}">

                    {% for form in panel_form.choices %}
                        <div class="choices-item" data-answer-index="{{ form.index }}">
                            {% crispy form %}
                        </div>
                    {% endfor %}

                    {% if panel_form.choices.non_form_errors %}
                        <div class="alert alert-danger" role="alert">
                            {{ panel_form.choices.non_form_errors|join:", " }}
                        </div>
                    {% endif %}
                </div>

                {% comment %}
                <div style="max-width:60rem" class="form-text">
                    Choice key is configurable as you might want to match the keys
                    used to some other system.<br/> (For example, if you are using a third party system to
                    analytize analytics.)
                </div>
                {% endcomment %}

                <button id="add-choice-{{ block.id }}"
                        class="btn btn-primary action-button"
                        type="button">
                    Add Choice
                </button>

                {# This template is used each time the user clicks "Add Answer. So it should be the same as rows generated by the form. #}
                <template id="poll-choice-template-{{ block.id }}">
                    <div class="choices-item"
                         data-answer-index=""
                         data-is-new-row="true">
                        <div class="row">
                            {# 'data-answer-index' will be set to correct index when template is added #}
                            <div class="col-1">
                                <div class="mb-3">
                                    {# '__index_' will be renamed to correct index when template is added #}
                                    <label class="sr-only" for="id_poll-definition-__index__-choice_key">Choice key</label>
                                    <input id="id_poll-definition-__index__-choice_key"
                                           name="poll-definition-__index__-choice_key"
                                           type="text"
                                           class="form-control textinput"
                                           style="width: 3rem"
                                           maxlength="2"
                                           size="2"/>
                                </div>
                            </div>
                            <div class="col-9">
                                <div class="mb-3">
                                    {# '-__index_' will be renamed to correct index when template is added #}
                                    <label class="sr-only" for="id_poll-definition-__index__-text">Choice text</label>
                                    <input id="id_poll-definition-__index__-text"
                                           name="poll-definition-__index__-text"
                                           type="text"
                                           class="form-control textinput">
                                </div>
                            </div>
                            <div class="col-1">
                                <button type="button" class="btn btn-danger btn-sm btn-remove-choice">Delete</button>
                            </div>
                        </div>
                    </div>
                </template>

            </div>
        </fieldset>

        <fieldset style="margin-bottom: 1rem;">
            <div class="fieldset-contents">
              {{ panel_form.graded|as_crispy_field }}
              {{ panel_form.max_score|as_crispy_field }}
              {{ panel_form.attempts_allowed|as_crispy_field }}
              {{ panel_form.complete_mode|as_crispy_field }}
            </div>
        </fieldset>

    </div>

    <div class="card-footer action-buttons">

        <div class="actions-left">

            <a id="btn-cancel-panel-{{ block.id }}-{{ current_panel_slug }}"
               style="margin-right:auto;"
               href="{% url 'composer:course_edit_unit_node' course_id=course.id unit_node_id=unit_node.id %}"
               class="btn btn-warning btn-sm action-button d-none">
                Cancel
            </a>
        </div>
        
        <div class="actions-right">
            
            <button id="btn-save-panel-{{ block.id }}-{{ current_panel_slug }}"
                    type="submit"
                    disabled
                    class="btn btn-primary btn-sm action-button me-3">
                Save
            </button>

            <button id="btn-done-panel-{{ block.id }}-{{ current_panel_slug }}"
                    hx-get="{% url 'composer:blocks:view_course_unit_block_hx' course_id=course.id module_node_id=module_node.id section_node_id=section_node.id unit_node_id=unit_node.id course_unit_id=course_unit.id pk=block.id %}"
                    type="button"
                    class="btn btn-secondary btn-sm action-button">
                Done
            </button>
        </div>

    </div>

</div>

 {% comment %}
    TODO:
        This javascript section is just proof of concept. The code here should probably be moved to
        a library and written in Typescript to remain consistent.
{% endcomment %}

<script type="module">

    function triggerFormChangeEvent() {
        const form = document.getElementById('panel-form-{{block.id}}-POLL');
        if (form) {
            const changeEvent = new Event('change', {bubbles: true});
            form.dispatchEvent(changeEvent);
        }
    }


    // Function to get the next index before adding a new "choice" row
    function getNextIndex() {
        const choicesContainer = document.getElementById('choices-container-{{ block.id }}');
        console.log("choicesContainer: ", choicesContainer);
        const choicesItems = choicesContainer.getElementsByClassName('choices-item');
        const nextIndex = Array.from(choicesItems).reduce((highestIndex, element) => {
            console.log("Finding index on element: ", element);
            let index = parseInt(element.dataset.answerIndex || 0);
            console.log("index is : ", index);
            return index > highestIndex ? index : highestIndex;
        }, 0) + 1;
        console.log('nextIndex: ', nextIndex);
        return nextIndex;
    }

    // Function to assign an index to a newly created "choice" row
    function setNextIndex(newChoiceFragment, index) {
        if (!newChoiceFragment) {
            console.error('setNextIndex() row is undefined');
            return;
        }
        if (!index) {
            console.error('setNextIndex() index is undefined');
            return;
        }
        console.log("newChoiceFragment: ", newChoiceFragment);
        console.log("new index: ", index);
        const choiceItem = newChoiceFragment.querySelector('.choices-item');
        console.log("new choiceItem div: ", choiceItem);
        choiceItem.dataset.answerIndex = index;
        console.log("new choiceItem.data.answerIndex now: ", choiceItem.dataset.answerIndex);
        const formControls = choiceItem.querySelectorAll('.form-control');
        formControls.forEach((element) => {
            const newName = element.getAttribute('name').replace('__index__', index);
            element.setAttribute('name', newName);
        });
    }

    function updateTotalFormsCount() {
        const choicesContainer = document.getElementById('choices-container-{{ block.id }}');
        const choicesItems = choicesContainer.getElementsByClassName('choices-item');
        const totalForms = choicesItems.length;
        console.log("Updating total forms count to: ", totalForms);
        const totalFormsInput = document.getElementById('id_poll-definition-TOTAL_FORMS');
        totalFormsInput.value = totalForms;
    }

    function addChoiceDefinitionRow() {

        const nextIndex = getNextIndex()

        const template = document.getElementById('poll-choice-template-{{ block.id }}');
        const newRow = template.content.cloneNode(true);
        setNextIndex(newRow, nextIndex);

        // Add event listener to the new "Delete" button
        const deleteButton = newRow.querySelector('.btn-remove-choice');
        deleteButton.addEventListener('click', function (event) {
            removeChoiceDefinitionRow(event.target);
        });

        const choicesContainer = document.getElementById('choices-container-{{ block.id }}');
        choicesContainer.appendChild(newRow);

        updateTotalFormsCount();

        triggerFormChangeEvent();

    }

    function removeChoiceDefinitionRow(button) {

        const row = button.closest('.row');
        console.log("Removing row: ", row);
        const choicesItemRow = row.parentNode;
        console.log("Removing choicesItemRow: ", choicesItemRow);
        const isNewRow = choicesItemRow.dataset.isNewRow;
        const rowIndex = choicesItemRow.dataset.answerIndex;

        // Set the DELETE checkbox to true if this is an existing row.
        if (!isNewRow) {
            console.log("Setting DELETE checkbox to true for row: ", rowIndex);
            const hiddenDeleteElem = document.getElementById(`id_poll-definition-${rowIndex}-DELETE`);
            if (hiddenDeleteElem) {
                hiddenDeleteElem.value = "true";
                console.log("Set hiddenDeleteElem checkbox to true for row: ", rowIndex);
            } else {
                console.error(`hiddenDeleteElem not found for row: ${rowIndex}`);
            }
        }

        // Hide the parent row
        choicesItemRow.classList.add('d-none');
        console.log("choicesItemRow: ", choicesItemRow);
        console.log("isNewRow: ", isNewRow);


        triggerFormChangeEvent();

    }

    // Add listeners to delete row buttons.
    const choicesContainer = document.getElementById('choices-container-{{ block.id }}');
    const deleteButtons = choicesContainer.querySelectorAll('.btn-remove-choice');
    deleteButtons.forEach(function (button) {
        button.addEventListener('click', function (event) {
            removeChoiceDefinitionRow(event.target);
        });
    });

    // Event listener for the "Add Choice" button.
    const addChoiceBtn = document.getElementById('add-choice-{{ block.id }}')
    console.log("Adding listener to add choice button : ", addChoiceBtn);
    addChoiceBtn.addEventListener('click', function (event) {
        addChoiceDefinitionRow();
    });


</script>
